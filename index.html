function generateRounds(){
  fixtures.innerHTML='';
  const numCourts = +courts.value;
  const activeCount = numCourts * 4;

  for(let round=1; round<=ROUND_LIMIT; round++){
    let html = `<div class="round"><strong>Round ${round}</strong>`;
    let teams=[], used=new Set();

    const women = players.filter(p=>p.gender==='W');
    const men   = players.filter(p=>p.gender==='M');

    const maxWomenActive = Math.min(women.length, numCourts*2);
    const minWomenIdle   = women.length - maxWomenActive;

    const idleSlots = players.length - activeCount;

    // Step 1: determine who is allowed to idle
    let idleCandidates;
    if(minWomenIdle <= 0){
      // women scarce → only men may idle
      idleCandidates = [...men];
    } else {
      // women surplus → anyone may idle
      idleCandidates = [...players];
    }

    // Step 2: choose idle fairly
    idleCandidates.sort(
      (a,b)=> (idleCount[b.id]-idleCount[a.id]) || (a.id-b.id)
    );

    const idle = idleCandidates.slice(0, idleSlots);
    idle.forEach(p=>idleCount[p.id]++);

    const idleIds = new Set(idle.map(p=>p.id));
    const active  = players.filter(p=>!idleIds.has(p.id));

    const menA   = active.filter(p=>p.gender==='M');
    const womenA = active.filter(p=>p.gender==='W');

    // Step 3: MW pairing (primary)
    let mwPairs=[];
    menA.forEach(m=>{
      womenA.forEach(w=>{
        mwPairs.push({
          m,w,
          used: pairHistory[pairKey(m,w)]||0
        });
      });
    });
    mwPairs.sort((a,b)=>a.used-b.used);

    for(const p of mwPairs){
      if(used.has(p.m.id)||used.has(p.w.id)) continue;
      teams.push({a:p.m,b:p.w});
      used.add(p.m.id); used.add(p.w.id);
      pairHistory[pairKey(p.m,p.w)] =
        (pairHistory[pairKey(p.m,p.w)]||0)+1;
      if(teams.length===numCourts*2) break;
    }

    // Step 4: fallback (only if needed)
    const freeW = womenA.filter(p=>!used.has(p.id));
    const freeM = menA.filter(p=>!used.has(p.id));

    for(let i=0;i+1<freeW.length && teams.length<numCourts*2;i+=2){
      teams.push({a:freeW[i],b:freeW[i+1]});
      used.add(freeW[i].id); used.add(freeW[i+1].id);
    }

    for(let i=0;i+1<freeM.length && teams.length<numCourts*2;i+=2){
      teams.push({a:freeM[i],b:freeM[i+1]});
      used.add(freeM[i].id); used.add(freeM[i+1].id);
    }

    // Step 5: render
    for(let i=0;i+1<teams.length;i+=2){
      html += `<div class="match">
        (${teams[i].a.name} + ${teams[i].b.name})
        vs
        (${teams[i+1].a.name} + ${teams[i+1].b.name})
      </div>`;
    }

    html += `<div class="idle">Idle: ${idle.map(p=>p.name).join(', ')}</div></div>`;
    fixtures.innerHTML += html;
  }

  fixturesCard.style.display='block';
}
