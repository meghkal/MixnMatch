<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mix n Match — v7.4 (No Empty Rounds)</title>

<style>
/* (styles unchanged – identical to v7.3) */
:root{
  --page-bg:#f5f6f7;
  --card-bg:#0f2435;
  --card-text:#e7f3ff;
  --muted:#9aa6b4;
  --accent:#d4af37;
  --radius:10px;
  --input-height:48px;
}
*,*::before,*::after{box-sizing:border-box;}
body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--page-bg);}
.banner{position:fixed;top:0;left:0;right:0;height:46px;display:flex;align-items:center;justify-content:center;background:var(--card-bg);color:var(--card-text);font-weight:700;font-size:13px;}
body{padding-top:46px;}
.wrap{max-width:1100px;margin:0 auto;padding:12px 16px;}
.card{background:var(--card-bg);color:var(--card-text);border-radius:var(--radius);padding:16px;margin-bottom:12px;}
.title{font-weight:700;margin-bottom:12px;}
input,select{width:100%;height:var(--input-height);padding:0 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.05);color:var(--card-text);}
.btn{height:var(--input-height);padding:0 16px;border-radius:8px;font-weight:700;border:none;cursor:pointer;}
.btn.primary{background:var(--accent);color:#102238;}
.action-row{display:flex;gap:10px;justify-content:flex-end;margin-top:12px;}
.round{background:rgba(255,255,255,0.03);padding:12px;border-radius:8px;margin-top:10px;}
.match{padding:6px 0;}
.idle{font-size:12.5px;color:var(--muted);margin-top:6px;}
</style>
</head>

<body>
<div class="banner">Mix n Match — v7.4</div>
<div class="wrap">

<div class="card">
  <div class="title">Setup</div>
  <input id="courts" type="number" value="2">
  <input id="count" type="number" value="12">
  <div class="action-row">
    <button class="btn primary" onclick="startEntry()">Next</button>
  </div>
</div>

<div class="card" id="entryCard" style="display:none;">
  <div id="entry"></div>
  <div class="action-row">
    <button class="btn primary" onclick="savePlayers()">Generate Fixtures</button>
  </div>
</div>

<div class="card" id="fixturesCard" style="display:none;">
  <div id="fixtures"></div>
</div>

<script>
let players=[], rounds=[], pairHistory={}, idleCount={};
const ROUND_LIMIT=8;

function startEntry(){
  let h='';
  for(let i=1;i<=count.value;i++){
    h+=`<input id="n${i}" placeholder="Player ${i}">
        <select id="g${i}">
          <option value="">Gender</option>
          <option value="W">Woman</option>
          <option value="M">Man</option>
        </select>`;
  }
  entry.innerHTML=h;
  entryCard.style.display='block';
}

function savePlayers(){
  players=[]; idleCount={}; pairHistory={}; rounds=[];
  for(let i=1;i<=count.value;i++){
    players.push({id:i,name:n(i).value,gender:g(i).value,playedLastRound:false});
    idleCount[i]=0;
  }
  generateRounds();
}

const n=i=>document.getElementById('n'+i);
const g=i=>document.getElementById('g'+i);
const pairKey=(a,b)=>[a.id,b.id].sort().join('-');

function generateRounds(){
  fixtures.innerHTML='';
  const numCourts=+courts.value;
  const activeCount=numCourts*4;

  for(let r=1;r<=ROUND_LIMIT;r++){
    let used=new Set(), teams=[];
    let sorted=[...players].sort((a,b)=>idleCount[a.id]-idleCount[b.id]);
    let idle=sorted.slice(0,players.length-activeCount);
    let active=sorted.slice(players.length-activeCount);
    idle.forEach(p=>idleCount[p.id]++);

    function buildTeams(){
      used.clear(); teams=[];
      const men=active.filter(p=>p.gender==='M');
      const women=active.filter(p=>p.gender==='W');
      let mw=[];
      men.forEach(m=>women.forEach(w=>mw.push({m,w,u:pairHistory[pairKey(m,w)]||0})));
      mw.sort((a,b)=>a.u-b.u);
      for(const p of mw){
        if(used.has(p.m.id)||used.has(p.w.id)) continue;
        teams.push({a:p.m,b:p.w});
        used.add(p.m.id); used.add(p.w.id);
        pairHistory[pairKey(p.m,p.w)]=(pairHistory[pairKey(p.m,p.w)]||0)+1;
        if(teams.length===numCourts*2) break;
      }
    }

    buildTeams();

    // FINAL GUARANTEE
    if(teams.length<2){
      idle.forEach(p=>idleCount[p.id]--);
      idle=[];
      active=[...players];
      buildTeams();
    }

    let h=`<div class="round"><strong>Round ${r}</strong>`;
    for(let i=0;i+1<teams.length;i+=2){
      h+=`<div class="match">(${teams[i].a.name}+${teams[i].b.name}) vs (${teams[i+1].a.name}+${teams[i+1].b.name})</div>`;
    }
    h+=`<div class="idle">Idle: ${idle.map(p=>p.name).join(', ')}</div></div>`;
    fixtures.innerHTML+=h;
  }
  fixturesCard.style.display='block';
}
</script>
</body>
</html>
